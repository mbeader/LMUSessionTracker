@if(session && session.session && session.standings) {
<h3>Standings</h3>
<table class="table table-sm table-striped table-hover">
    <thead>
        <tr>
            <th scope="col" class="text-center">Status</th>
            <th scope="col" class="text-center">Pos</th>
            <th scope="col" class="text-center">PIC</th>
            <th scope="col" class="text-center">Class</th>
            <th scope="col" class="text-center">#</th>
            <th scope="col" class="team-col">Team</th>
            <th scope="col" class="driver-col">Driver</th>
            <th scope="col" class="text-end">Laps</th>
            <th scope="col" class="text-end time-col">Behind</th>
            <th scope="col" class="text-end time-col">Int</th>
            @if(isRace) {
            <th scope="col" class="text-end time-col">Best</th>
            } @else {
            <th scope="col" class="text-end time-col">Time</th>
            }
            <th scope="col" class="text-end time-col">Last</th>
            <th scope="col" class="text-end time-col">S1</th>
            <th scope="col" class="text-end time-col">S2</th>
            <th scope="col" class="text-end time-col">S3</th>
            <th scope="col" class="text-end time-col">Fuel</th>
            <th scope="col" class="text-center">Lap%</th>
            <th scope="col" class="text-center"></th>
        </tr>
    </thead>
    <tbody>
        @for (standing of session.standings; track CarKey.fromStanding(standing).id; let i = $index) {
        @let id = CarKey.fromStanding(standing).id;
        @let car = entries.get(id ?? '');
        @let carClass = (car && car.class ? car.class : standing.carClass) ?? '';
        @let bestClasses = getLastClasses(standing, carClass);
        @if(car) {
        <tr [attr.car-id]="id">
            @let status = Format.status(standing);
            @let statusClass = Utils.statusClass(status);
            <td class="text-center"><span class="{{ statusClass }}">{{ status }}</span></td>
            @let classId = Utils.classId(carClass);
            <td class="text-center {{ positionInClass.get(id ?? '') == 1 ? `pic-${classId}` : null }}">{{ standing.position }}</td>
            <td class="text-center pic-{{ classId }}">{{ positionInClass.get(id ?? '') }}</td>
            <td class="text-center"><app-session-class-badge [carClass]="carClass" /></td>
            <td class="text-center">{{ car?.number ? car.number : standing.carNumber }}</td>
            @let team = car?.teamName ? car.teamName : (!standing.fullTeamName ? standing.vehicleName : standing.fullTeamName);
            <td class="team-col text-truncate" title="{{ team }}">{{ team }}</td>
            <td class="driver-col text-truncate" title="{{ standing.driverName }}">{{ standing.driverName }}</td>
            <td class="text-end">{{ standing.lapsCompleted }}</td>
            <td class="text-end time-col">{{ !isRace && standing.timeBehindLeader <= 0 ? '-' : Format.diff(standing.lapsBehindLeader, standing.timeBehindLeader) }}</td>
            <td class="text-end time-col">{{ !isRace && standing.timeBehindLeader <= 0 ? '-' : Format.diff(standing.lapsBehindNext, standing.timeBehindNext) }}</td>
            <td class="text-end time-col {{ getBestClasses(standing, carClass).total }}">{{ Format.lapTime(standing.bestLapTime) }}</td>
            <td class="text-end time-col {{ bestClasses.total }}">{{ Format.lapTime(standing.lastLapTime) }}</td>
            <td class="text-end time-col {{ bestClasses.sector1 }}">{{ Format.sectorTime(0.0, standing.sector == "SECTOR1" ? standing.lastSectorTime1 : standing.currentSectorTime1) }}</td>
            <td class="text-end time-col {{ bestClasses.sector2 }}">{{ standing.sector == "SECTOR2" ? "" : standing.sector == "SECTOR1" ? Format.sectorTime(standing.lastSectorTime1, standing.lastSectorTime2) : Format.sectorTime(standing.currentSectorTime1, standing.currentSectorTime2) }}</td>
            <td class="text-end time-col {{ bestClasses.sector3 }}">{{ standing.sector != "SECTOR1" ? "" : Format.sectorTime(standing.lastSectorTime2, standing.lastLapTime) }}</td>
            @let fuelClass = standing.fuelFraction > .1 ? '' : standing.fuelFraction > .05 ? 'text-warning' : 'text-danger';
            <td class="text-end time-col {{ fuelClass }}">{{ Format.percent(standing.fuelFraction) }}</td>
            <td class="text-center"><span class="border bg-secondary-subtle" title="{{ Format.distance(standing.lapDistance, session.session.lapDistance) }}"><span class="lap-prog-{{ Format.lapProgress(standing.lapDistance, session.session.lapDistance) }}"></span></span></td>
            <td class="">
                <div class="dropdown">
                    <button class="btn-icon ms-auto dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                            <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                        </svg>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#statusModal">View full status</button></li>
                        <li><a class="dropdown-item" [routerLink]="['Laps', `${id}`]">Laps</a></li>
                    </ul>
                </div>
            </td>
        </tr>
        }
        }
    </tbody>
</table>
}

<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="statusModalLabel">
                    Status
                    @if(carStatusDesc) {
                    -
                    <span class="fs-6"><app-session-class-badge [carClass]="carStatusDesc.carClass" /></span>
                    <span> #{{ carStatusDesc.number }} {{ carStatusDesc.team }}</span>
                    }
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <app-session-car-status />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
